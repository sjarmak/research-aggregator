[dotenv@17.2.3] injecting env (1) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
User: Find the definition of 'Agent' in github.com/sourcegraph/amp
Agent starting...
Available tools: [
  'Bash',
  'create_file',
  'edit_file',
  'finder',
  'glob',
  'Grep',
  'librarian',
  'mcp__ace_learning_server__ace_analyze_patterns',
  'mcp__ace_learning_server__ace_capture_trace',
  'mcp__ace_learning_server__ace_get_insights',
  'mcp__ace_learning_server__ace_update_knowledge',
  'mcp__custom_subagents__get_subagent_manifest',
  'mcp__custom_subagents__invoke_subagent',
  'mcp__custom_subagents__list_subagents',
  'mcp__custom_subagents__search_subagents',
  'mcp__tools_server__get_recent_articles',
  'mcp__tools_server__get_recent_papers_context',
  'mcp__tools_server__lookup_personal_papers',
  'mcp__tools_server__multi_source_research',
  'mcp__tools_server__sg_read_file',
  'mcp__tools_server__sg_search',
  'mermaid',
  'oracle',
  'Read',
  'read_mcp_resource',
  'read_thread',
  'read_web_page',
  'skill',
  'Task',
  'todo_read',
  'todo_write',
  'undo_edit',
  'web_search',
  'xai_finder',
  'fast_finder',
  'kimiK2_finder',
  'gossip_finder',
  'sonoma_finder',
  'edit_plan',
  'read_plan'
]
[Tool Use] mcp__tools_server__sg_search({"query":"repo:github.com/sourcegraph/amp type:symbol Agent"})
[Tool Use] mcp__tools_server__sg_search({"query":"repo:github.com/sourcegraph/amp \"type Agent\" OR \"class Agent\" OR \"interface Agent\""})
[Tool Use] mcp__tools_server__sg_search({"query":"repo:github.com/sourcegraph/amp file:README.md"})
[Tool Use] librarian({"query":"Find the definition of 'Agent' in the repository github.com/sourcegraph/amp"})

--- Result ---
[QUERY_ANALYSIS]
- **Restatement**: The user wants to find the code definition of the `Agent` entity within the `github.com/sourcegraph/amp` repository.
- **Domain**: code
- **Sub-questions**:
  1. What file contains the definition of `Agent` (or its equivalent main class/interface)?
  2. What is the code structure of this definition?
[/QUERY_ANALYSIS]

[SEARCH_NOTES]
- **Tools Used**: `librarian`
- **Key Findings**:
  - (Librarian Analysis): The repository defines "Agent" primarily through two classes:
    1. `ScaffoldedAgent` (Generic Framework) in `core/src/tools/scaffolded-agent/agent.ts` (Relevance: 5/5)
    2. `SubAgent` (Concrete Implementation) in `core/src/tools/sub-agent.ts` (Relevance: 5/5)
[/SEARCH_NOTES]

[REFLECTION]
- **Coverage**: The search successfully identified the core agent abstractions in the specified repository.
- **Gaps**: None. The distinction between the generic scaffold and the concrete implementation is clear.
[/REFLECTION]

[FINAL_ANSWER]
In `github.com/sourcegraph/amp`, the concept of an "Agent" is defined through two primary classes that handle tool execution and conversation management.

### 1. ScaffoldedAgent (Generic Framework)
**Location**: [`core/src/tools/scaffolded-agent/agent.ts`](https://github.com/sourcegraph/amp/blob/main/core/src/tools/scaffolded-agent/agent.ts)

The `ScaffoldedAgent` is a generic, template-based class that implements the `Disposable` interface. It uses a "scaffold" pattern to customize behavior (inference, message extraction, conversation updates).

```typescript
export class ScaffoldedAgent<R, C> implements Disposable {
    #abort = new AbortController()
    #progress = new Subject<ScaffoldedAgentStatus>()
    
    constructor(
        private systemPrompt: string,
        private model: string,
        private scaffold: Scaffold<R, C>,
    ) {}

    public run(
        conversation: C,
        toolService: SubToolService,
        env: ToolRunEnvironment,
    ): Observable<ScaffoldedAgentStatus>
}
```

### 2. SubAgent (Concrete Implementation)
**Location**: [`core/src/tools/sub-agent.ts`](https://github.com/sourcegraph/amp/blob/main/core/src/tools/sub-agent.ts)

The `SubAgent` is a concrete implementation that extends `Subject`. It is specifically designed to use Anthropic's models for inference and manages a conversation history.

```typescript
export class SubAgent extends Subject<SubAgentStatus> implements Disposable {
    constructor(
        tools: ToolRegistration<any>[],
        subAgentSystemPrompt: string,
        userPrompt: string,
        env: ToolRunEnvironment,
        modelOverride?: string,
    )
}
```

**References:**
- [ScaffoldedAgent Definition](https://github.com/sourcegraph/amp/blob/main/core/src/tools/scaffolded-agent/agent.ts)
- [SubAgent Definition](https://github.com/sourcegraph/amp/blob/main/core/src/tools/sub-agent.ts)
[/FINAL_ANSWER]
